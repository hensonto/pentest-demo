# Penetration Testing Techtalk (06-22-2022)

## Introduction to Pen Testing

This techtalk introduces you to the world of pentration testing thru bug hunting and ethical hacking, 
this includes responsibly discovering security vulnerabilities (does not cause any disruption) and 
reporting them to the application owner.

This article would not only show you what type of vulnerability can be found but also how to find them.
We would try to answer the following question:
1. How do we learn about vulnerabilities?
2. How do we begin infiltrating a site? 
3. What are the types of vulenrability to look for?

**The best way to learn is simply by doing** and there are countless of ways for us to do this from a 3rd party
company asking us to pentest their app to signing up in a bounty program like hackerone all the way to choosing 
a random target in the internet. For this activity we would be using JuiceShop, it is an open source project by 
non profit **[Open Web Application Security Project® (OWASP)](https://owasp.org/)**. As en excerpt the OWASP 
Juice Shop is supposed to be the opposite of a best practice or template application for web developers: It is an 
awareness, training, demonstration and exercise tool for security risks in modern web applications, basically it
is a web app with a vast number of security vulnerability that anyone can exploit.

## Scope and Limitation

This techtalk would serve as an introduction to pentesting and most activities are quite basic.
1. No source code or secure coding topics.
2. Exploit level (difficulty): low to medium low
3. We would only test the juiceshop webapp, no other testing will be performed in the `network`, 
`operating system`, `log`, `other services` and `leaks (git, passwords....)`.

## Setting up your juice shop environment

We would be spinning up the juiceshop docker image for our acivity. There are 2 ways for you start juice shop.

First one is to start it directly from the console
```bash
$ docker pull bkimminich/juice-shop
$ docker run --rm -p 3000:3000 bkimminich/juice-shop
```
Second one is to use the included docker compose
```bash
$ cd ./pentest-demo/juiceshop
$ docker-compose up
```
Juice shop can be access thru your browser by browsing http://localhost:3000

Note: Once you stop the docker image, all progress would be lost. This is by design as it is common to have a messed
up environment while trying to solve certain challenges. Excerpt from their site: https://pwning.owasp-juice.shop/part1/running.html
```
Self-healing-feature

OWASP Juice Shop was not exactly designed and built with a high availability and reactive enterprise-scale 
architecture in mind. It runs perfectly fine and fast when it is attacked via a browser by a human. When 
under attack by an automated tool - especially aggressive brute force scripts - the server might crash under 
the load. This could - in theory - leave the database and file system in an unpredictable state that prevents 
a restart of the application.

That is why - in practice - Juice Shop wipes the entire database and the folder users might have modified during 
hacking. After performing this self-healing the application is supposed to be restartable, no matter what kind of 
problem originally caused it to crash. For convenience the self-healing happens during the start-up (i.e. npm start) 
of the server, so no extra command needs to be issued to trigger it.
```

## Tools that we would be using

There are ton's of tools that we can use but for this exercise we would only use the following tools:
[Burpsuite](https://portswigger.net/burp) - Integrated platform for performing security testing of web applications. 
The tool acts as a web proxy and intercepts traffic.
[SQLMap](https://github.com/sqlmapproject/sqlmap) - Automatic SQL injection and database takeover tool.

It is also important to know your target example if the target is using NoSQL (non relational db like MongoDB or HBase) 
instead of SQL (MySQL, MsSQL, Postgres.....) then there is a possibility that using SQLMap would not catch anything
hence you have to use [NoSQLMap](https://github.com/codingo/NoSQLMap) which is built for nosql type db.

We also need dictionary files to start our attack and there are a lot of resource in the internet but for this
demo we would be using [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings)

## Things to look for

It is important to have atleast a basic understanding of how the internet works and what happens when we enter a url
into the address bar of our browser. There are a lot of things that happen under the hood when we are browsing the 
internet, for instance when we enter www.google.com, these are the things that your browser would do.
1. It identifies the domain of the request
2. Translate the domain into IP address using DNS
3. Establishing TCP connection   
4. Preparing the HTTP request
5. If using HTTPS, create the HTTPS handshake
6. Sending the request
7. Receiving the response
8. Rendering the response to the browser

Before we start let's define `Vulnerability`, A vulnerability is a weakness in an application that allows a malicious 
person to perform some unpermitted action or gain access to information they shouldn’t otherwise be allowed to access.

There are ton's of vulnerability and you can see the vull list of vulnerability from 
[OWASP List of Vulnerabilities](https://owasp.org/www-community/vulnerabilities/) but for this activity we would only
be discussing some of [OWASP Top Ten](https://owasp.org/www-project-top-ten/).

1. [Borken Access Control](https://owasp.org/Top10/A01_2021-Broken_Access_Control/) - Access control enforces policy 
   such that users cannot act outside of their intended permissions. Failures typically lead to unauthorized 
   information disclosure, modification, or destruction of all data or performing a business function outside the 
   user's limits.
2. [Injection](https://owasp.org/Top10/A03_2021-Injection/) - Some of the more common injections are SQL, NoSQL, 
   OS command, Object Relational Mapping (ORM), LDAP, and Expression Language (EL) or Object Graph Navigation 
   Library (OGNL) injection.
3. [Security Misconfiguration](https://owasp.org/Top10/A05_2021-Security_Misconfiguration/) - This issue is mostly
   related to configuration issue where maybe unnecesry features or ports where enables, it may also be due to weak 
   Error handling reveals stack traces or other overly informative error messages to users
4. [Vulnerable and Outdated Components](https://owasp.org/Top10/A06_2021-Vulnerable_and_Outdated_Components/) - This
   issue is self explanatory but in general the web app is using an outdated and or unpatched component that are
   vulnerable to exploit
6. [Identification and Authentication Failures](https://owasp.org/Top10/A07_2021-Identification_and_Authentication_Failures/) -
   This includes password complexity enforcement

## Bonus content

You might expereince some webapp being protected by cloudflare, basically cloudflare is a type of waf. To demonstrate 
how can a WAF protect your web app from attack, I have added a docker image that uses modsecurity.

```bash
$ cd ./pentest-demo/juiceshop-waf
$ docker-compose up
```

**Unprotected** - http://127.0.0.1:3000
**Protected** - http://127.0.0.1:3001

Let try to do an `SQLi` and see if the WAF can block it.
1. Go to http://127.0.0.1:3001
2. Click on Account then Login
3. Enter the following: Email: `' OR true--` and Password: `Anything`

You should see an error
```html
<html>
  <head>
     <title>403 Forbidden</title>
  </head> 
  <body> 
    <center><h1>403 Forbidden</h1></center> <hr><center>nginx/1.18.0</center> 
  </body> 
</html> 
```

You can also tail the modsecurity log
```bash
$ docker-compose exec waf bash
$ tail -f /var/log/modsec_audit.log

```

Doing the same thing in the unprotected server would not produce any error and will let you log into juiceshop as admin

As you would see WAF is also signature based and you can try to play around with input and or look for other ways to 
exploit it. The rules are found in `./juiceshop-waf/conf/rules`

To read more about modsucrity you can refer to: https://github.com/SpiderLabs/ModSecurity
